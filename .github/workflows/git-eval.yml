name: Git-Eval F Rank

on:
  push:
    branches: ["**"]
  pull_request:
    branches: [main]

jobs:
  evaluate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Evaluate
        id: eval
        run: |
          SCORE=0
          FEEDBACK=""
          INSTANT_FAIL=false

          # Instant fail: .env committed
          if find . -name '.env' -not -path './.git/*' | grep -q .; then
            INSTANT_FAIL=true
            FEEDBACK="${FEEDBACK}üö´ Âç≥„Ç¢„Ç¶„Éà: .env „Éï„Ç°„Ç§„É´„Åå push „Åï„Çå„Å¶„ÅÑ„Åæ„Åô\n"
          fi

          # Instant fail: CRLF
          if grep -rPl '\r$' --include='*.js' --include='*.ts' --include='*.py' --include='*.json' --include='*.toml' --include='*.yaml' --include='*.yml' --include='*.md' --include='*.txt' . 2>/dev/null | head -1 | grep -q .; then
            INSTANT_FAIL=true
            FEEDBACK="${FEEDBACK}üö´ Âç≥„Ç¢„Ç¶„Éà: CRLF ÊîπË°å„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü\n"
          fi

          if [ "$INSTANT_FAIL" = true ]; then
            SCORE=0
            FEEDBACK="${FEEDBACK}\nÂç≥„Ç¢„Ç¶„ÉàÊù°‰ª∂„Å´Ë©≤ÂΩì„Åô„Çã„Åü„ÇÅ 0 ÁÇπ„Åß„Åô„ÄÇ"
          else
            # Check 1: .gitignore exists and non-empty (20pts)
            if [ -s .gitignore ]; then
              SCORE=$((SCORE + 20))
              FEEDBACK="${FEEDBACK}‚úÖ .gitignore „ÅåÈÅ©Âàá„Å´Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô\n"
            else
              FEEDBACK="${FEEDBACK}‚ùå .gitignore „ÅåÂ≠òÂú®„Åó„Å™„ÅÑ„ÅãÁ©∫„Åß„Åô\n"
            fi

            # Check 2: .gitattributes exists (15pts)
            if [ -f .gitattributes ]; then
              SCORE=$((SCORE + 15))
              FEEDBACK="${FEEDBACK}‚úÖ .gitattributes „ÅåÂ≠òÂú®„Åó„Åæ„Åô\n"
            else
              FEEDBACK="${FEEDBACK}‚ùå .gitattributes „Åå„ÅÇ„Çä„Åæ„Åõ„Çì\n"
            fi

            # Check 3: Project config file exists (25pts)
            if ls package.json Cargo.toml pyproject.toml go.mod build.gradle pom.xml Gemfile composer.json 2>/dev/null | head -1 | grep -q .; then
              SCORE=$((SCORE + 25))
              FEEDBACK="${FEEDBACK}‚úÖ „Éó„É≠„Ç∏„Çß„ÇØ„ÉàË®≠ÂÆö„Éï„Ç°„Ç§„É´„ÅåÂ≠òÂú®„Åó„Åæ„Åô\n"
            else
              FEEDBACK="${FEEDBACK}‚ùå „Éó„É≠„Ç∏„Çß„ÇØ„ÉàË®≠ÂÆö„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì (package.json, Cargo.toml, pyproject.toml Á≠â)\n"
            fi

            # Check 4: Source directory exists (15pts)
            if ls -d src/ lib/ app/ cmd/ pkg/ 2>/dev/null | head -1 | grep -q .; then
              SCORE=$((SCORE + 15))
              FEEDBACK="${FEEDBACK}‚úÖ „ÇΩ„Éº„Çπ„Éá„Ç£„É¨„ÇØ„Éà„É™„ÅåÂ≠òÂú®„Åó„Åæ„Åô\n"
            else
              FEEDBACK="${FEEDBACK}‚ùå src/ Á≠â„ÅÆ„ÇΩ„Éº„Çπ„Éá„Ç£„É¨„ÇØ„Éà„É™„Åå„ÅÇ„Çä„Åæ„Åõ„Çì\n"
            fi

            # Check 5: README.md updated (10pts)
            README_LINES=$(wc -l < README.md 2>/dev/null || echo 0)
            if [ "$README_LINES" -gt 5 ]; then
              SCORE=$((SCORE + 10))
              FEEDBACK="${FEEDBACK}‚úÖ README.md „ÅåÊõ¥Êñ∞„Åï„Çå„Å¶„ÅÑ„Åæ„Åô\n"
            else
              FEEDBACK="${FEEDBACK}‚ùå README.md „ÇíËá™ÂàÜ„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁî®„Å´Êõ¥Êñ∞„Åó„Åæ„Åó„Çá„ÅÜ\n"
            fi

            # Check 6: No junk files committed (15pts)
            if ! find . -path './.git' -prune -o \( -name 'node_modules' -o -name '__pycache__' -o -name '.DS_Store' -o -name 'Thumbs.db' -o -name '*.pyc' \) -print | grep -q .; then
              SCORE=$((SCORE + 15))
              FEEDBACK="${FEEDBACK}‚úÖ ‰∏çË¶Å„Éï„Ç°„Ç§„É´„Åå„Ç≥„Éü„ÉÉ„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì\n"
            else
              FEEDBACK="${FEEDBACK}‚ùå ‰∏çË¶Å„Éï„Ç°„Ç§„É´ (node_modules, __pycache__ Á≠â) „Åå„Ç≥„Éü„ÉÉ„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åô\n"
            fi
          fi

          FEEDBACK="${FEEDBACK}\nÂêàË®à„Çπ„Ç≥„Ç¢: ${SCORE}/100"

          echo "score=$SCORE" >> $GITHUB_OUTPUT
          {
            echo "feedback<<EVAL_EOF"
            echo -e "$FEEDBACK"
            echo "EVAL_EOF"
          } >> $GITHUB_OUTPUT

      - name: Send results to Git-Eval
        if: always()
        env:
          WEBHOOK_SECRET: ${{ secrets.GIT_EVAL_SECRET }}
          WEBHOOK_URL: ${{ secrets.GIT_EVAL_URL }}
        run: |
          if [ -z "$WEBHOOK_URL" ] || [ -z "$WEBHOOK_SECRET" ]; then
            echo "Webhook not configured, skipping"
            exit 0
          fi

          BODY=$(jq -n \
            --arg user "${{ github.actor }}" \
            --argjson score ${{ steps.eval.outputs.score }} \
            --arg feedback "${{ steps.eval.outputs.feedback }}" \
            '{github_username: $user, score: $score, feedback: $feedback}')

          SIG=$(echo -n "$BODY" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" | sed 's/^.* //')

          curl -sf -X POST "${WEBHOOK_URL}/webhook/eval" \
            -H "Content-Type: application/json" \
            -H "X-Signature-256: sha256=${SIG}" \
            -d "$BODY"
